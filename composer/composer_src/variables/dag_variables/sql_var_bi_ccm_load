{
    "bi_ccm_load_sql": "insert into bt-tch-3g-sunset-dp-dev.dp_net_mobnet_rw.bi_ccm_agg_mth(subscriber_num,  price_plan, agg_mth,  stack,  current_brand,  business_type,  billing_base, arpu, subscriber_status,  active_30d_payg,  active_90d_payg,  account_num,  sub_id, base_type,  account_type, contract_start_date,  contract_end_date)  select subscriber_num,  price_plan, agg_mth,  stack,  current_brand,  business_type,  billing_base, arpu, subscriber_status,  active_30d_payg,  active_90d_payg,  account_num,  sub_id, base_type,  account_type, contract_start_date,  contract_end_date from (  with cdm_bvp as (select cdm.account_num,cast((extract(year from cdm.snapshot_date)||lpad(cast(extract(month from cdm.snapshot_date)as string), 2, '0')) as string) as agg_mth,cdm.csm_stack as stack, cdm.service_product_code as price_plan,cdm.service_id as sub_id, cdm.service_product_type as base_type,case when safe_cast(cdm.ctn as int) = bvp.subscriber_num then bvp.current_brand else cdm.brand end as current_brand,cdm.service_id_status as subscriber_status,cdm.ctn as subscriber_num,'PAYM' as billing_base,cdm.total_service_product_rev_pm as arpu,case when safe_cast(cdm.ctn as int) = bvp.subscriber_num then bvp.account_typeelse 'N/A' end as account_type,'Consumer' as business_type,-1 as active_30d_payg,-1 as active_90d_payg, cdm.contract_start_date, cdm.contract_end_date FROM bt-con-fincdmi-dp-dev.con_dp_cdm_base_ro.cdm_dly_base as cdm LEFT JOIN ( SELECT DISTINCT subscriber_num, account_type,agg_mth, current_brand, contract_start_dat FROM bt-bvp-dataprod-dp-dev.cons_bvp_dp_cdm_data_product_ro.vw_bvp_dp_010_bq_cdm_bi_ccm_agg_mth_raw) AS bvp ON safe_cast(cdm.ctn as int) = bvp.subscriber_num and cast((extract(year from cdm.snapshot_date)||lpad(cast(extract(month from cdm.snapshot_date)as string), 2, '0')) as string) = cast(bvp.agg_mth as string) and cdm.contract_start_date = bvp.contract_start_date where cdm.service = 'Mobile' and ( cdm.snapshot_date  = last_day(date_sub(current_date(), interval 1 month))) union distinct select cast(bvp.account_num as string) as account_num,cast(bvp.agg_mth as string)as agg_mth,bvp.stack, bvp.price_plan,cast(bvp.sub_id as string) as sub_id,bvp.base_type, bvp.current_brand,bvp.subscriber_status,case when cast(bvp.subscriber_num as string) not like '0%' then concat('0', cast(bvp.subscriber_num as string)) else cast(bvp.subscriber_num as string) end as subscriber_num, bvp.billing_base,cast(bvp.arpu as numeric) as arpu,bvp.account_type, bvp.business_type, bvp.active_30d_payg, bvp.active_90d_payg,  bvp.contract_start_date,  bvp.contract_end_date from bt-bvp-dataprod-dp-dev.cons_bvp_dp_cdm_data_product_ro.vw_bvp_dp_010_bq_cdm_bi_ccm_agg_mth_raw as bvp where cast(bvp.agg_mth as string) = (cast(date_add(date_trunc(current_date(), month), interval -1 month) AS STRING FORMAT 'YYYYMM')) and --All non consumer :  (bvp.business_type <> 'Consumer' -- Active Consumer Payg:   or (bvp.business_type = 'Consumer' and bvp.billing_base = 'PAYG'  --  exclude orange payg and (bvp.current_brand<>'Orange' and bvp.billing_base = 'PAYG')   )) ) SELECTcase when subscriber_num not like '0%' then concat('0', subscriber_num) else subscriber_num end as subscriber_num,price_plan,agg_mth,stack,current_brand,business_type,billing_base,arpu,subscriber_status,active_30d_payg,active_90d_payg,account_num,sub_id,base_type,account_type,extract(date from contract_start_date) as contract_start_date,extract(date from contract_end_date) as contract_end_date from cdm_bvp   )"

}
